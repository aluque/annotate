<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotate</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Toolbar -->
<div id="toolbar">
  <div class="app-logo">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" stroke="none"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    Annotate
  </div>

  <div class="sep"></div>

  <button class="btn btn-tool active" id="btn-select" title="Select (S)" onclick="setMode('select')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" stroke="none">
      <path d="M4 2l16 10-7 1.5-3.5 7.5z"/>
    </svg>
    <kbd>S</kbd>
  </button>
  <button class="btn btn-tool" id="btn-point" title="Add point (P)" onclick="setMode('point')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="5"/></svg>
    <kbd>P</kbd>
  </button>
  <button class="btn btn-tool" id="btn-line" title="Add line (L)" onclick="setMode('line')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
      <line x1="4" y1="20" x2="20" y2="4"/>
    </svg>
    <kbd>L</kbd>
  </button>
  <button class="btn btn-tool" id="btn-rect" title="Add rectangle (R)" onclick="setMode('rect')">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="5" width="18" height="14" rx="1.5"/>
    </svg>
    <kbd>R</kbd>
  </button>

  <div class="sep"></div>

  <div class="file-menu" id="file-menu">
    <button class="btn btn-file-menu" id="btn-file" onclick="toggleFileMenu(event)">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
        <polyline points="13 2 13 9 20 9"/>
      </svg>
      File
      <svg class="file-chevron" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </button>
    <div class="file-dropdown" id="file-dropdown">
      <button class="file-dropdown-item" onclick="document.getElementById('file-input').click()">
        <svg class="file-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
          <polyline points="13 2 13 9 20 9"/>
        </svg>
        Open Image
      </button>
      <button class="file-dropdown-item" onclick="document.getElementById('json-input').click()">
        <svg class="file-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Import JSON
      </button>
      <button class="file-dropdown-item" onclick="downloadJSON()">
        <svg class="file-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export JSON
      </button>
      <div class="file-dropdown-divider"></div>
      <button class="file-dropdown-item file-item-danger" onclick="clearAnnotations()">
        <svg class="file-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/>
          <path d="M10 11v6M14 11v6"/>
          <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/>
        </svg>
        Clear All
      </button>
    </div>
  </div>

  <div class="tools-menu" id="tools-menu">
    <button class="btn btn-tools" id="btn-tools" onclick="toggleToolsMenu(event)">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
      </svg>
      Tools
      <svg class="tools-chevron" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </button>
    <div class="tools-dropdown" id="tools-dropdown">
      <button class="tools-dropdown-item" onclick="openToolDialog('extract')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <polyline points="4 18 4 4 20 4"/>
          <circle cx="9" cy="13" r="2" fill="currentColor" stroke="none"/>
          <circle cx="13" cy="9" r="2" fill="currentColor" stroke="none"/>
          <circle cx="17" cy="15" r="2" fill="currentColor" stroke="none"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Extract</span>
          <span class="tools-item-desc">Project points onto plot axes</span>
        </span>
      </button>
      <button class="tools-dropdown-item" onclick="openToolDialog('measure')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="8" width="20" height="8" rx="2"/>
          <line x1="6" y1="12" x2="6" y2="16"/>
          <line x1="10" y1="12" x2="10" y2="14"/>
          <line x1="14" y1="12" x2="14" y2="14"/>
          <line x1="18" y1="12" x2="18" y2="16"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Measure</span>
          <span class="tools-item-desc">Measure line lengths via scale</span>
        </span>
      </button>
      <button class="tools-dropdown-item" onclick="openToolDialog('profile')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="4 20 4 4 20 4"/>
          <polyline points="4 16 7 10 10 14 13 8 17 12 20 9"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Profile</span>
          <span class="tools-item-desc">Sample intensity along lines</span>
        </span>
      </button>
      <button class="tools-dropdown-item" onclick="openToolDialog('angle')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="20" x2="21" y2="20"/>
          <line x1="3" y1="20" x2="14" y2="5"/>
          <path d="M10 20 A8 8 0 0 1 8.7 14.7"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Angle</span>
          <span class="tools-item-desc">Measure line orientations</span>
        </span>
      </button>
      <button class="tools-dropdown-item" onclick="openToolDialog('distances')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="5" cy="12" r="2.5" fill="currentColor" stroke="none"/>
          <circle cx="19" cy="12" r="2.5" fill="currentColor" stroke="none"/>
          <line x1="7.5" y1="12" x2="16.5" y2="12"/>
          <line x1="7.5" y1="9" x2="7.5" y2="15"/>
          <line x1="16.5" y1="9" x2="16.5" y2="15"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Distances</span>
          <span class="tools-item-desc">Pairwise point distances</span>
        </span>
      </button>
      <button class="tools-dropdown-item" onclick="openToolDialog('area')">
        <svg class="tools-item-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="14" height="12" rx="1"/>
          <line x1="20" y1="5" x2="22" y2="5"/>
          <line x1="20" y1="17" x2="22" y2="17"/>
          <line x1="21" y1="5" x2="21" y2="17"/>
          <line x1="3" y1="20" x2="17" y2="20"/>
        </svg>
        <span class="tools-item-text">
          <span class="tools-item-name">Area</span>
          <span class="tools-item-desc">Rectangle dimensions &amp; area</span>
        </span>
      </button>
    </div>
  </div>

  <button class="btn btn-theme-icon" id="btn-theme" title="Toggle theme" onclick="toggleTheme()">
    <svg class="icon-sun" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="1" x2="12" y2="3"/>
      <line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/>
      <line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <svg class="icon-moon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/>
    </svg>
  </button>

  <input type="file" id="file-input" accept="image/*">
  <input type="file" id="json-input" accept=".json">
</div>

<!-- Main -->
<div id="main">

  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-section-header">
      Annotations
      <span id="ann-count">0</span>
    </div>
    <div class="prefix-row">
      <label class="prefix-label" for="prefix-input">Prefix</label>
      <input type="text" id="prefix-input" class="prefix-input" value="Point" spellcheck="false" title="Label prefix for new annotations">
    </div>
    <div id="annotation-list"></div>

    <div id="tags-panel">
      <div class="sidebar-section-header">
        Tags
        <button class="tag-add-btn" title="New tag" onclick="startAddTag()">
          <svg width="11" height="11" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="6" y1="1" x2="6" y2="11"/><line x1="1" y1="6" x2="11" y2="6"/>
          </svg>
        </button>
      </div>
      <div id="tags-list"></div>
    </div>

    <div id="zoom-panel">
      <div class="zoom-header">
        Zoom <span class="zoom-factor">4×</span>
      </div>
      <canvas id="zoom-canvas"></canvas>
    </div>
  </div>

  <!-- Canvas area -->
  <div id="canvas-area">
    <div id="drop-zone">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" stroke="none"/>
        <polyline points="21 15 16 10 5 21"/>
      </svg>
      <h2>Open an image to begin</h2>
      <p>Click "Open Image" above, or drag &amp; drop an image file here</p>
    </div>
    <div id="canvas-wrapper">
      <canvas id="main-canvas"></canvas>
    </div>
    <div id="coords-hud">—</div>
  </div>

</div>

<!-- Status bar -->
<div id="statusbar">
  <span>Tool: <span id="status-mode">Select</span></span>
  <span>
    <span class="sb-key">S</span> Select &nbsp;
    <span class="sb-key">P</span> Point &nbsp;
    <span class="sb-key">L</span> Line &nbsp;
    <span class="sb-key">R</span> Rect &nbsp;
    <span class="sb-key">Del</span> Delete &nbsp;
    <span class="sb-key">Esc</span> Cancel &nbsp;
    <span class="sb-key">F</span> Fit &nbsp;
    <span class="sb-key">M</span> Labels &nbsp;
    <span class="sb-key">Tab</span> Next &nbsp;
    <span class="sb-key">⌘Z</span> Undo &nbsp;
    <span class="sb-key">R-drag</span> Pan
  </span>
  <span id="status-hint"></span>
</div>

<div class="modal-overlay" id="tool-modal">
  <div class="modal-card">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-title">Tool</h2>
      <button class="modal-close" onclick="closeToolDialog()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="modal-desc" id="modal-desc"></p>
      <div class="modal-field">
        <label class="modal-label" for="modal-tag-select">Tag filter</label>
        <select class="modal-select" id="modal-tag-select">
          <option value="">All tags</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="closeToolDialog()">Cancel</button>
      <button class="btn-modal-primary" onclick="runCurrentTool()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download CSV
      </button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
